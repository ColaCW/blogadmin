<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="shortcut icon" type="image/x-icon" href="img/gaga.jpg">
  <title>编辑博客</title>
  <link rel="stylesheet" href="css/addBlog.css"/>
</head>
<body>
<div id="app" style="height:99%" v-cloak>
  <div class="head">
    <div class="blog-title" v-if="id == ''">新建博客</div>
    <div class="blog-title" v-else>编辑&nbsp;&nbsp;{{blog.name}}</div>
    <div style="float:right;">
      <div class="push-btn" @click="$('.releaseBoxWrap').fadeIn()">
        <img src="img/发布.png" style="float: left;width: 25px">
        <div style="float: left;height: 30px;line-height: 30px;margin-left: 5px">发布文章</div>
        <div style="clear: both"></div>
      </div>
      <div class="user">
        <img src="../static/img/gaga.jpg" class="layui-nav-img" style="border-radius:16px;width:30px">
      </div>
    </div>
    <div style="clear: both"></div>
  </div>
  <div class="tool-bar">
    <div class="return-btn">
      <img src="img/返回.png" style="float: left;width: 20px;margin-top: 5px;">
      <div style="float: left;height: 30px;line-height: 30px;margin-left: 5px">返回后台</div>
      <div style="clear: both"></div>
    </div>
    <div class="upload-btn" title="上传" @click="$('.uploadBoxWrap').fadeIn()">
      <img src="img/上传.png" style="width: 30px">
    </div>
    <div class="save-btn" title="保存" @click="save(1)">
      <img src="img/保存.png" style="width: 25px;margin-top:2px;margin-left: 2px;">
    </div>
    <div class="preview-btn" :title="isPreview ? '编辑':'预览'" @click="changePreview()">
      <img src="img/眼睛.png" style="width: 25px;margin-top:2px;margin-left: 2px;" v-show="!isPreview">
      <img src="img/笔.png" style="width: 25px;margin-top:2px;margin-left: 2px;" v-show="isPreview">
    </div>
  </div>
  <div class="main">
    <div class="input-region">
      <textarea id="content" @keyup="compile()" v-model="blog.markdown"></textarea>
    </div>
    <div class="result-region">
      <div id="result"></div>
    </div>
    <div style="clear: both;"></div>
  </div>

  <div class="releaseBoxWrap">
    <div class="releaseBox">
        <div class="box-head">
          <div class="head-title">发布文章</div>
          <div class="close"><img src="/static/img/close.png" style="width: 20px;" @click="$('.releaseBoxWrap').fadeOut()"/></div>
          <div style="clear: both"></div>
        </div>
        <div class="blog-name">
          博客名称:
          <input type="text" v-model="blog.name" style="width: 100px;"><span style="color:red;margin-left: 2px;">*</span>
        </div>
        <div class="blog-type" v-if="blogCategorys && blogCategorys.length>0">
        博客分类:
        <select style="width: 100px;" v-model="blog.categoryId">
          <template v-for="blogCategory in blogCategorys">
            <option :value="blogCategory.id">{{blogCategory.name}}</option>
          </template>
        </select><span style="color:red;margin-left: 2px;">*</span>
      </div>
        <div class="release-btn">
          <div class="releaseBtn" @click="save(2)">发布</div>
          <div class="cancelBtn" @click="$('.releaseBoxWrap').fadeOut()">取消</div>
          <div style="clear: both"></div>
        </div>
    </div>
  </div>

  <!--上传框-->
  <div class="uploadBoxWrap" onclick="$('.uploadBoxWrap').fadeOut()">
    <div class="uploadBox">
      <iframe id="uploadHtml" src="uploadFile.html"></iframe>
    </div>
  </div>
  <!--上传框-->

</div>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/store.min.js"></script>
<script type="text/javascript" src="js/vue.min.js"></script>
<script type="text/javascript" src="js/showdown.js"></script>
<script type="text/javascript" src="js/web1.js"></script>
<script type="text/javascript">
  var app = new Vue({
    el:"#app",
    data:{
      token:Web.getToken(),
      id:"",
      isPreview:false,
      blog:{},
      blogCategorys:[]
    },
    methods:{
      init:function () {
        var that = this;
        that.id = Web.getParam("","id","");
        that.doRead();
        that.getBlogCategory();
      },

      compile:function(){
        var that = this;
        var text = document.getElementById("content").value;
        var converter = new showdown.Converter();
        var html = converter.makeHtml(text);
        document.getElementById("result").innerHTML = html;
        that.blog.content = html;
      },
      getBlogCategory:function(){
          var that = this;
          var data = {
            token:that.token
          };
          Web.post(Web.host + "/api/BlogCategory/search.do",data,function (res) {
            if(res.status){
              that.blogCategorys = res.data;
            }
          })
      },
      doRead:function () {
          var that = this;
          var data = {
            token:that.token,
            id:that.id
          };
          Web.post(Web.host + "/api/Blog/read.do",data,function (res) {
            if(res.status){
              that.blog = res.data;
              that.$nextTick(function () {
                that.compile();
              });
            }
          })
      },
      doCreate:function (type) {
        var that = this;
        var data = {
          token:that.token,
          obj:that.blog
        };
        Web.post(Web.host + "/api/Blog/create.do",data,function (res) {
          if(res.status){
            that.blog = res.data;
            if(type == 1){
              Web.showToast("保存成功",2000);
            }else{
              Web.showToast("发布成功",2000);
              window.close();
            }
          }else{
            if(type == 1){
              Web.showToast("保存失败",2000);
            }else{
              Web.showToast("发布失败",2000);
            }
          }
        })
      },
      doUpdate:function (type) {
          var that = this;
          var data = {
            token:that.token,
            obj:that.blog
          };
          Web.post(Web.host + "/api/Blog/update.do",data,function (res) {
            if(res.status){
              that.blog = res.data;
              if(type == 1){
                Web.showToast("保存成功",2000);
              }else{
                Web.showToast("发布成功",2000);
                window.close();
              }
            }else{
              if(type == 1){
                Web.showToast("保存失败",2000);
              }else{
                Web.showToast("发布失败",2000);
              }
            }
          })
      },
      save:function(type){
        var that = this;
        if(type == 2){
          that.blog.status = 2;
        }
        if(that.blog.id && that.blog.id != ""){
            that.doUpdate(type);
        }else{
            that.doCreate(type);
        }
      },
      changePreview:function(){
        var that = this;
        that.isPreview = !that.isPreview;
        if(that.isPreview){
          $(".input-region").hide();
          $(".result-region").css("width","100%");
        }else{
          $(".input-region").show();
          $(".result-region").css("width","50%");
        }
      },
      uploadCallback:function (info) {
        var callback_data = JSON.parse(info)
      }
    }
  });
  app.init();
</script>
</body>
</html>
